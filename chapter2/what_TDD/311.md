# 测试-编码-重构

在本节的开头我们介绍了TDD的原则：“编写能够通过测试的代码”。

换而言之就是先写测试代码，接着编码让测试通过，这与我们平时学到的有些矛盾。平时我们优先设计，编码实现，紧接着进行测试找到代码中问题。而TDD完全颠覆了这个过程。

测试先行，然后编码，最后设计。这种设计有别于传统的“设计-编码-测试”过程中的设计，因为两种设计的差别很大，这种后设计的模式有一个我们十分熟知的名字——重构。表示把当前设计转化为一个更佳设计的过程。

## 先写测试

在TDD周期中的第一步中我们会写测试，实际上这同时也是在做设计。我们是在设计API，用来访问新功能的接口，编写测试前，我们会很自然的考虑接口的调用方式。从这个角度观察代码我们的思路会发生很大变化，让我们通过用户的角度考虑接口的设计，让接口变得更加易用，我们有时呆望着第三方类库的接口考虑改如何使用它，这些类库的开发人员一定是站在开发人员的角度设计接口的，完全没有从用户角度出发。如能测试先行的开发，我们肯定会对类库设计的好坏有所体验。

---

注意：编写测试时应该注意粒度，尽可能的编写“正好足以失败”的测试。而不是写出整个功能点的测试，然后花费大量时间编写代码来通过测试。

---

用TDD可以设计出模块化且可测试的代码。因为要测试先行，所以我们必须要让代码可测试，在TDD中所有代码都是可测试的，否则就不应该存在。

设计并不是只强调结果，满足当前需求更加重要，避免过度设计。开发额外不需要的功能不仅浪费时间，同时还要花费大量时间与精力维护，对与当前不需要的需求TDD鼓励搁置开发只将它记录下来当需要时再进行开发，可能有些功能永远不用实现。

使用TDD开发你会明确知道现在需要什么功能，小步前进逐步构建系统，在自动化测试报的保护伞下，我们不会在误入歧途，而且会很清楚前进的方向，同时也能够确信所实现的功能正是客户所需的。强调现在是TDD的核心，这个核心思想在第二步会再次得到体现，即写恰巧足够的代码。

## 写恰巧足够的代码

编写恰好能够通过测试的代码是TDD周期的第二步，为什么恰巧足够就可以？新加的测试代码之所以失败，是因为它指出了系统应该有但尚未实现的功能。我们应改只用几分钟就能实现这个功能，测试失败的状态不应该持续太长时间。

让测试指出下一步该做的事正式TDD的基本理念。测试能够帮助我们毫无歧义的描述出一个功能。

---

注意：写恰好通过测试的代码是为了让测试快速通过。因此实现方式或许不是最优的，不过没关系，等功能实现了、测试通过后我们再回来解决这个问题。有了测试做保护伞，就可以进行最后一步——重构了。

---

## 重构

重构是TDD测试-编码-重构中最后的一步。我们回头审视现有的代码设计，想办法改进。重构使得代码更加稳健。使用TDD而不进行重构会迅速产生大量烂代码。无论有多么充足的测试烂代码始终是烂代码。

